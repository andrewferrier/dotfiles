#!/usr/bin/env bash

set -o errexit
set -o noglob
set -o nounset
set -o pipefail

shopt -s inherit_errexit

# See https://support.mozilla.org/sv/questions/1316956,
# https://video.stackexchange.com/questions/13164/encoding-422-in-10-bit-with-libx264,
# https://superuser.com/questions/859010/what-ffmpeg-command-line-produces-video-more-compatible-across-all-devices

start() {
    USE_SCREENKEY=$(echo -e "Yes\nNo" | rofi -dmenu -p "Use screenkey?")

    if [[ "$USE_SCREENKEY" == "Yes" ]]; then
        screenkey -p fixed -g 60%x10%+20%-15% &
        notify-send --urgency low --expire-time=2000 "screenkey started."
    fi

    ID=$(notify-send --urgency low "Screen recording starting in 3..." --print-id --transient)
    sleep 1
    notify-send --urgency low "Screen recording starting in 2..." --replace-id="${ID}" --transient
    sleep 1
    notify-send --urgency low --expire-time=950 "Screen recording starting in 1..." --replace-id="${ID}" --transient
    sleep 1

    TIMESTAMP=$(date +"%Y-%m-%dT%H-%M-%S")
    OUTPUT_FILENAME="${TIMESTAMP}-screencast.mp4"

    dunstctl set-paused true

    # WIP: Add capability to include webcam
    # VIDEO_DEVICE=$(v4l2-ctl --list-devices | grep -A1 "OBSBOT Meet SE" | tail -n1 | tr -d ' \t')
    #
    # (
    #     set +o errexit
    #     ffmpeg \
    #         -f x11grab -framerate 30 -video_size 1920x1010 -i :0.0+0,32 \
    #         -f pulse -i default \
    #         -f v4l2 -input_format nv12 -i "$VIDEO_DEVICE" -video_size 640x480 -framerate 30 \
    #         -vaapi_device /dev/dri/renderD128 \
    #         -filter_complex "
    #     [0:v]format=nv12,hwupload=extra_hw_frames=8[screencast_hw];
    #     [2:v]hwupload,scale_vaapi=format=nv12[webcam_scaled_hw];
    #     [screencast_hw][webcam_scaled_hw]overlay_vaapi=x=W-w-20:y=H-h-20[out_v]" \
    #         -map "[out_v]" \
    #         -map 1:a \
    #         -c:v h264_vaapi -qp 24 \
    #         -c:a aac -b:a 160k -ac 1 \
    #         -movflags faststart \
    #         "${OUTPUT_FILENAME}"
    #     set -o errexit
    # )

    (
        set +o errexit
        ffmpeg \
            -f x11grab -framerate 30 -video_size 1920x1010 -i :0.0+0,32 \
            -f pulse -i default \
            -vaapi_device /dev/dri/renderD128 \
            -vf 'format=nv12,hwupload' \
            -c:v h264_vaapi -qp 24 \
            -c:a aac -b:a 160k -ac 1 \
            -movflags faststart \
            "${OUTPUT_FILENAME}" 2>&1 | logger -t 'recordscreen'
        set -o errexit
    )

    dunstctl set-paused false
    killall screenkey || true
}

stop() {
    PID=$(pgrep -a ffmpeg | grep -F screencast | cut -d' ' -f1)
    kill "$PID"
    notify-send --urgency low "Screen recording stopped."
}

if pgrep -a ffmpeg | grep -F screencast >/dev/null; then
    stop
else
    start
fi
