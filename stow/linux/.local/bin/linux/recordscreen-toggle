#!/usr/bin/env bash

set -o errexit
set -o noglob
set -o nounset
set -o pipefail

shopt -s inherit_errexit

# See https://support.mozilla.org/sv/questions/1316956,
# https://video.stackexchange.com/questions/13164/encoding-422-in-10-bit-with-libx264,
# https://superuser.com/questions/859010/what-ffmpeg-command-line-produces-video-more-compatible-across-all-devices

start() {
    USE_SCREENKEY=$(echo -e "Yes\nNo" | rofi -dmenu -p "Use screenkey?")

    if [[ "$USE_SCREENKEY" == "Yes" ]]; then
        screenkey -p fixed -g 60%x10%+20%-15% &
        notify-send --urgency low --expire-time=2000 "screenkey started."
    fi

    notify-send --urgency low --expire-time=950 "Screen recording starting in 3..."
    sleep 1
    notify-send --urgency low --expire-time=950 "Screen recording starting in 2..."
    sleep 1
    notify-send --urgency low --expire-time=800 "Screen recording starting in 1..."
    sleep 1

    TIMESTAMP=$(date +"%Y-%m-%dT%H-%M-%S")
    OUTPUT_FILENAME="${TIMESTAMP}-screencast.mp4"

    dunstctl set-paused true
    ffmpeg \
        -f x11grab -framerate 30 -video_size 1920x1010 -i :0.0+0,32 \
        -f pulse -i default \
        -vaapi_device /dev/dri/renderD128 \
        -vf 'format=nv12,hwupload' \
        -c:v h264_vaapi -qp 24 \
        -c:a aac -b:a 160k -ac 1 \
        -movflags faststart \
        "${OUTPUT_FILENAME}" 2>&1 | logger -t 'recordscreen'
}

stop() {
    killall ffmpeg
    killall screenkey || true
    dunstctl set-paused false
    notify-send --urgency low "Screen recording stopped."
}

if pgrep -a ffmpeg | grep -F screencast >/dev/null; then
    stop
else
    start
fi
