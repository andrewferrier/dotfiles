#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

ONLY_BLUETOOTH=false

while getopts "b" o; do
    case "${o}" in
    b)
        # Boolean option
        ONLY_BLUETOOTH=true
        ;;
    *)
        echo >&2 "Unrecognized option."
        exit 1
        ;;
    esac
done
shift $((OPTIND - 1))

BLUETOOTH_STATE=$(rfkill -o DEVICE,SOFT -J list bluetooth | jq -r '.rfkilldevices[0].soft')
WIFI_STATE=$(rfkill -o DEVICE,SOFT -J list wifi | jq -r '.rfkilldevices[0].soft')

if ${ONLY_BLUETOOTH}; then
    if [[ ${BLUETOOTH_STATE} == 'unblocked' ]]; then
        notify-send 'Bluetooth blocked.'
        sudo systemctl stop bluetooth
        sudo rfkill block bluetooth
    else
        notify-send 'Bluetooth unblocked.'
        sudo rfkill unblock bluetooth
        sudo systemctl start bluetooth
    fi
else
    if [[ ${WIFI_STATE} == 'unblocked' || ${BLUETOOTH_STATE} == 'unblocked' ]]; then
        notify-send 'Radios blocked.'
        sudo rfkill block wifi
        sudo systemctl stop bluetooth
        sudo rfkill block bluetooth
    else
        notify-send 'Radios unblocked.'
        sudo rfkill unblock wifi
        sudo rfkill unblock bluetooth
        sudo systemctl start bluetooth
    fi
fi
