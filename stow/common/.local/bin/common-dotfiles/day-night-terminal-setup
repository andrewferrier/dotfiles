#!/usr/bin/env bash

CACHE_DIR="${HOME}/.cache/day-night"
STATE_FILE="${CACHE_DIR}/state-terminal"
STATE_FILE_KITTY_LAST="${CACHE_DIR}/state-kitty-lastset"

# TODO: Detect the terminal background in the same way NeoVim does

if [[ -z "${SSH_CONNECTION}" ]]; then
    # It seems that occasionally calling 'kitty @ set-colors' is responsible for
    # swallowing keypresses. However, by checking against the 'KITTY_LAST' file,
    # the need/frequency to do that is minimized.
    if [[ ! -f "${STATE_FILE_KITTY_LAST}" ]] || ! cmp --silent "${STATE_FILE}" "${STATE_FILE_KITTY_LAST}"; then
        if grep -Fxq "day" "${STATE_FILE}"; then
            kitty @ set-colors --all --configured ~/.config/kitty/colors-light.conf
        else
            kitty @ set-colors --all --configured ~/.config/kitty/colors-dark.conf
        fi

        command cp "${STATE_FILE}" "${STATE_FILE_KITTY_LAST}"
    fi

    if grep -Fxq "day" "${STATE_FILE}"; then
        # Built myself based on Gruvbox Dark below
        # shellcheck disable=SC2154
        export FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS_INITIAL --color fg:#1d2021,bg:#f9f5d7,hl:#fb4934,fg+:#3c3836,bg+:#ebdbb2,hl+:#fb4934 --color info:#b8bb26,prompt:#b8bb26,spinner:#83a598,pointer:#fabd2f,marker:#665c54,header:#fe8019"
        export BAT_THEME="gruvbox-light"
    else
        # See https://github.com/junegunn/fzf/wiki/Color-schemes#gruvbox-dark
        export FZF_DEFAULT_OPTS="$FZF_DEFAULT_OPTS_INITIAL --color fg:#f9f5d7,bg:#1d2021,hl:#fabd2f,fg+:#ebdbb2,bg+:#3c3836,hl+:#fabd2f --color info:#83a598,prompt:#bdae93,spinner:#fabd2f,pointer:#83a598,marker:#fe8019,header:#665c54"
        export BAT_THEME="gruvbox-dark"
    fi
fi
